name: Frontend CI with Backend and Cypress

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout frontend repo
        uses: actions/checkout@v3

      - name: Checkout backend repo
        uses: actions/checkout@v3
        with:
          repository: LannyRivero/RenewSim-backend
          path: backend

      # Copy init.sql from backend repo to frontend repo root (for MySQL)
      - name: Copy init.sql from backend
        run: cp backend/init.sql .

      # Start backend + MySQL + Cypress via docker-compose from frontend repo
      - name: Start all services with docker-compose
        run: docker-compose -f docker-compose.cypress.yml up -d

      # Wait for backend readiness
      - name: Wait for backend readiness
        run: |
          for i in {1..15}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
            if [[ "$status" == "200" || "$status" == "401" ]]; then
              echo "Backend is ready with status $status"
              exit 0
            fi
            echo "Waiting for backend, retrying in 5 seconds..."
            sleep 5
          done
          echo "Backend did not become ready in time."
          exit 1

      # Run Cypress tests inside container
      - name: Run Cypress tests
        run: docker-compose -f docker-compose.cypress.yml run --rm cypress

      # Setup Node.js for frontend build
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # Create .env file for frontend build
      - name: Create .env file
        run: |
          echo "VITE_API_BASE_URL=http://localhost:8080/api" > .env
          echo "VITE_AUTH_TOKEN_SECRET=your_secret_key" >> .env
          echo "VITE_OPENWEATHER_API_KEY=75a86c6a8e0e72b3b99cfbc6fb9bf349" >> .env

      # Install frontend dependencies
      - name: Install frontend dependencies
        run: npm ci

      # Build frontend
      - name: Build frontend
        run: npm run build

      # Shutdown docker compose services after tests
      - name: Stop docker-compose services
        run: docker-compose -f docker-compose.cypress.yml down









